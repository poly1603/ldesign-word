<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word Viewer - 性能监控示例</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    #viewer-container {
      width: 100%;
      height: 600px;
      border: 1px solid #ddd;
      margin-top: 20px;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .metric-card {
      padding: 15px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .metric-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .metric-label {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .warning {
      background: #fff3cd;
      border-color: #ffc107;
    }

    .critical {
      background: #f8d7da;
      border-color: #dc3545;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>⚡ Word Viewer - 性能监控示例</h1>

    <div class="controls">
      <input type="file" id="file-input" accept=".docx,.doc" />
      <button id="start-monitor">开始监控</button>
      <button id="stop-monitor">停止监控</button>
      <button id="clear-cache">清除缓存</button>
    </div>

    <div id="viewer-container"></div>

    <div class="metrics">
      <div class="metric-card" id="memory-card">
        <div class="metric-value" id="memory-value">-</div>
        <div class="metric-label">内存使用</div>
      </div>

      <div class="metric-card">
        <div class="metric-value" id="load-time">-</div>
        <div class="metric-label">加载时间</div>
      </div>

      <div class="metric-card">
        <div class="metric-value" id="cache-hits">0</div>
        <div class="metric-label">缓存命中</div>
      </div>

      <div class="metric-card">
        <div class="metric-value" id="fps">60</div>
        <div class="metric-label">帧率 (FPS)</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { WordViewer } from '../../dist/index.esm.js';
    import { MemoryMonitor, formatBytes } from '../../dist/utils/memory.js';
    import { Logger, LogLevel } from '../../dist/utils/logger.js';

    const viewer = new WordViewer('#viewer-container');
    const monitor = new MemoryMonitor(2000); // 每2秒检查
    const logger = new Logger({ level: LogLevel.DEBUG });

    let cacheHits = 0;

    // 内存监控
    monitor.onWarning((warning) => {
      logger.warn(`内存警告 [${warning.level}]: ${warning.message}`);

      const card = document.getElementById('memory-card');
      card.classList.remove('warning', 'critical');

      if (warning.level === 'critical') {
        card.classList.add('critical');
      } else if (warning.level === 'high') {
        card.classList.add('warning');
      }
    });

    // 开始监控
    document.getElementById('start-monitor').addEventListener('click', () => {
      monitor.start();
      logger.info('开始监控');
      updateMetrics();
    });

    // 停止监控
    document.getElementById('stop-monitor').addEventListener('click', () => {
      monitor.stop();
      logger.info('停止监控');
    });

    // 清除缓存
    document.getElementById('clear-cache').addEventListener('click', async () => {
      // 实现缓存清除
      logger.info('缓存已清除');
      cacheHits = 0;
      document.getElementById('cache-hits').textContent = '0';
    });

    // 加载文档
    document.getElementById('file-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const startTime = performance.now();

      try {
        await viewer.loadFile(file);
        const loadTime = performance.now() - startTime;

        document.getElementById('load-time').textContent = `${loadTime.toFixed(0)}ms`;
        logger.info('文档加载完成', { loadTime: `${loadTime.toFixed(2)}ms` });

        // 检测是否从缓存加载
        if (loadTime < 200) {
          cacheHits++;
          document.getElementById('cache-hits').textContent = cacheHits;
        }
      } catch (error) {
        logger.error('加载失败', error);
        alert('加载失败: ' + error.message);
      }
    });

    // 更新指标
    function updateMetrics() {
      setInterval(() => {
        const memInfo = monitor.getMemoryInfo();

        if (memInfo.usedJSHeapSize) {
          document.getElementById('memory-value').textContent =
            formatBytes(memInfo.usedJSHeapSize);
        }

        // 计算 FPS
        const fps = Math.round(1000 / (performance.now() - lastFrame));
        document.getElementById('fps').textContent = fps;
        lastFrame = performance.now();
      }, 1000);
    }

    let lastFrame = performance.now();

    // 监听事件
    viewer.on('loaded', () => {
      logger.info('文档加载事件触发');
    });

    viewer.on('error', (error) => {
      logger.error('错误事件触发', error);
    });

    viewer.on('progress', (progress) => {
      logger.debug('加载进度', { percentage: progress.percentage });
    });
  </script>
</body>

</html>