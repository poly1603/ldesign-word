<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word Viewer - 协作编辑示例</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #viewer-container {
      width: 100%;
      height: 600px;
      border: 1px solid #ddd;
      margin-top: 20px;
    }

    .users-panel {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
    }

    .user-item {
      display: inline-block;
      padding: 4px 12px;
      margin: 4px;
      border-radius: 12px;
      color: white;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>📝 Word Viewer - 协作编辑示例</h1>

    <div class="controls">
      <input type="file" id="file-input" accept=".docx,.doc" />
      <input type="text" id="user-name" placeholder="您的名字" value="用户1" />
      <button id="connect-btn">连接协作服务器</button>
      <button id="disconnect-btn" disabled>断开连接</button>
    </div>

    <div id="viewer-container"></div>

    <div class="users-panel">
      <h3>👥 在线用户</h3>
      <div id="users-list"></div>
    </div>
  </div>

  <script type="module">
    import { WordViewer } from '../../dist/index.esm.js';
    import { CollaborationManager } from '../../dist/modules/collaboration.js';

    const viewer = new WordViewer('#viewer-container', {
      editable: true,
      theme: 'light',
    });

    let collabManager = null;

    // 文件加载
    document.getElementById('file-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        await viewer.loadFile(file);
        console.log('文档已加载');
      }
    });

    // 连接协作服务器
    document.getElementById('connect-btn').addEventListener('click', async () => {
      const userName = document.getElementById('user-name').value || '匿名用户';

      collabManager = new CollaborationManager({
        userId: `user_${Date.now()}`,
        userName,
        serverUrl: 'ws://localhost:8080', // 替换为实际服务器地址
        transport: 'websocket',
      });

      // 设置回调
      collabManager.onUserJoin = (user) => {
        console.log('用户加入:', user);
        updateUsersList();
      };

      collabManager.onUserLeave = (userId) => {
        console.log('用户离开:', userId);
        updateUsersList();
      };

      try {
        await collabManager.connect();
        console.log('已连接到协作服务器');

        document.getElementById('connect-btn').disabled = true;
        document.getElementById('disconnect-btn').disabled = false;
      } catch (error) {
        console.error('连接失败:', error);
        alert('连接失败: ' + error.message);
      }
    });

    // 断开连接
    document.getElementById('disconnect-btn').addEventListener('click', () => {
      if (collabManager) {
        collabManager.disconnect();
        document.getElementById('connect-btn').disabled = false;
        document.getElementById('disconnect-btn').disabled = true;
      }
    });

    // 更新用户列表
    function updateUsersList() {
      if (!collabManager) return;

      const users = collabManager.getUsers();
      const usersList = document.getElementById('users-list');

      usersList.innerHTML = users.map(user => {
        return `<div class="user-item" style="background-color: ${user.color}">${user.name}</div>`;
      }).join('');
    }

    // 监听文档变更
    viewer.on('changed', () => {
      console.log('文档已修改');

      // 发送操作到协作服务器
      if (collabManager) {
        const operation = {
          id: `op_${Date.now()}`,
          type: 'replace',
          userId: collabManager.options.userId,
          timestamp: Date.now(),
          position: 0,
          content: 'modified',
        };

        collabManager.sendOperation(operation);
      }
    });
  </script>
</body>

</html>