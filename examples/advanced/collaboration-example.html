<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word Viewer - åä½œç¼–è¾‘ç¤ºä¾‹</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #viewer-container {
      width: 100%;
      height: 600px;
      border: 1px solid #ddd;
      margin-top: 20px;
    }

    .users-panel {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
    }

    .user-item {
      display: inline-block;
      padding: 4px 12px;
      margin: 4px;
      border-radius: 12px;
      color: white;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ“ Word Viewer - åä½œç¼–è¾‘ç¤ºä¾‹</h1>

    <div class="controls">
      <input type="file" id="file-input" accept=".docx,.doc" />
      <input type="text" id="user-name" placeholder="æ‚¨çš„åå­—" value="ç”¨æˆ·1" />
      <button id="connect-btn">è¿æ¥åä½œæœåŠ¡å™¨</button>
      <button id="disconnect-btn" disabled>æ–­å¼€è¿æ¥</button>
    </div>

    <div id="viewer-container"></div>

    <div class="users-panel">
      <h3>ğŸ‘¥ åœ¨çº¿ç”¨æˆ·</h3>
      <div id="users-list"></div>
    </div>
  </div>

  <script type="module">
    import { WordViewer } from '../../dist/index.esm.js';
    import { CollaborationManager } from '../../dist/modules/collaboration.js';

    const viewer = new WordViewer('#viewer-container', {
      editable: true,
      theme: 'light',
    });

    let collabManager = null;

    // æ–‡ä»¶åŠ è½½
    document.getElementById('file-input').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file) {
        await viewer.loadFile(file);
        console.log('æ–‡æ¡£å·²åŠ è½½');
      }
    });

    // è¿æ¥åä½œæœåŠ¡å™¨
    document.getElementById('connect-btn').addEventListener('click', async () => {
      const userName = document.getElementById('user-name').value || 'åŒ¿åç”¨æˆ·';

      collabManager = new CollaborationManager({
        userId: `user_${Date.now()}`,
        userName,
        serverUrl: 'ws://localhost:8080', // æ›¿æ¢ä¸ºå®é™…æœåŠ¡å™¨åœ°å€
        transport: 'websocket',
      });

      // è®¾ç½®å›è°ƒ
      collabManager.onUserJoin = (user) => {
        console.log('ç”¨æˆ·åŠ å…¥:', user);
        updateUsersList();
      };

      collabManager.onUserLeave = (userId) => {
        console.log('ç”¨æˆ·ç¦»å¼€:', userId);
        updateUsersList();
      };

      try {
        await collabManager.connect();
        console.log('å·²è¿æ¥åˆ°åä½œæœåŠ¡å™¨');

        document.getElementById('connect-btn').disabled = true;
        document.getElementById('disconnect-btn').disabled = false;
      } catch (error) {
        console.error('è¿æ¥å¤±è´¥:', error);
        alert('è¿æ¥å¤±è´¥: ' + error.message);
      }
    });

    // æ–­å¼€è¿æ¥
    document.getElementById('disconnect-btn').addEventListener('click', () => {
      if (collabManager) {
        collabManager.disconnect();
        document.getElementById('connect-btn').disabled = false;
        document.getElementById('disconnect-btn').disabled = true;
      }
    });

    // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
    function updateUsersList() {
      if (!collabManager) return;

      const users = collabManager.getUsers();
      const usersList = document.getElementById('users-list');

      usersList.innerHTML = users.map(user => {
        return `<div class="user-item" style="background-color: ${user.color}">${user.name}</div>`;
      }).join('');
    }

    // ç›‘å¬æ–‡æ¡£å˜æ›´
    viewer.on('changed', () => {
      console.log('æ–‡æ¡£å·²ä¿®æ”¹');

      // å‘é€æ“ä½œåˆ°åä½œæœåŠ¡å™¨
      if (collabManager) {
        const operation = {
          id: `op_${Date.now()}`,
          type: 'replace',
          userId: collabManager.options.userId,
          timestamp: Date.now(),
          position: 0,
          content: 'modified',
        };

        collabManager.sendOperation(operation);
      }
    });
  </script>
</body>

</html>